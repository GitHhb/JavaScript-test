<!DOCTYPE html>
<html>
<head>
	
	<title>Fietsroute Editor</title>

	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	
	<link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico" />
    <link rel="stylesheet" href="fietsroute-editor.css" />
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.2/dist/leaflet.css" />
	<script src="https://unpkg.com/leaflet@1.0.2/dist/leaflet.js"></script>

	<!-- Beautify markers -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
	<link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css">
	<link rel="stylesheet" href="BeautifyMarker/leaflet-beautify-marker-icon.css">
	<script src="BeautifyMarker/leaflet-beautify-marker-icon.js"></script>
	<script src="BeautifyMarker/leaflet-beautify-marker.js"></script>

	
</head>
<body>

<div id="mapdata">Loading...</div>

<div id="mapid" style="width: 1200px; height: 800px;"></div>
<button id="toon-mijn-route" onclick="toonMijnRoute()">Toon route</button>
<div id="mijn-route">Nog geen route gedefinieerd</div>

<script>
	var mymap;
	var mycontrol; // The base layer
	var knooppuntLayer; // pdok marker layer
	var knooppunten = []; // Array of type KnooppuntType
    var knooppuntenLoaded = false;
    var netwerken = []; // Array of type NetwerkenType
    var netwerkenLoaded = false;
    var netwerkK2K = []; // Array of type NetwerkK2K
    var myFietsrouteLayer = new L.LayerGroup(); // Layer with all parts for my own fietsroute


    // Knooppunten
    // Data obtained from layer "knooppunten" 
	// Knooppunt type delcaration
	function KnooppuntType (nr, point, xLng, yLat) {
		this.nr = nr;
        this.point = point; // type L.latLng
	}

    // Netwerk onderdelen
    // Data obtained from layer "netwerken"
	// Netwerken type declaration
	function NetwerkenType (name, point, coordinateArr) {
		this.name = name;   // network name, | from kml file
        this.point = point; // type L.latLng, | denotes the network location, from kml file
		this.coordinateArr = coordinateArr; // Array of L.latLng | coordinates for this route part (polyline), from kml file
        this.first = null; // index to knooppunten array | knooppunt corresponding to first route coords, coordinateArr[0], computed
        this.last = null; // index to knooppunten array | knooppunt corresponding to last route coords, coordinateArr[length-1], computed
	}

    // Netwerk parts from knooppunt to knooppunt
    // Constructed by us
    // NeterkK2K type declaration
    function NetwerkK2K () {
        this.first = null; // index to knooppunten array | knooppunt corresponding to first route coords, coordinateArr[0], computed
        this.last = null; // index to knooppunten array | knooppunt corresponding to last route coords, coordinateArr[length-1], computed
        this.netwerkenArr = []; // Array of indexes to array netwerken 
    }

    function MyFietsroute () {
        this.type;      // "n" (netwerken) || "k" (knooppunt) 
        this.knpt;  
    }

	// construct a new NetwerkenType object from a string of coordinates as returned in a kml file
	// return: new NetwerkenType object
	var stringToNetwerkenType = function (name, coordinateString) {
		var coordinateArr = [];

		return new NetwerkenType(name, coordinateArr);
	}

    // Compare coordinates
    // Args: c1, c2 of type L.latLng
    // return: true | false
    function compareCoord(c1, c2) {
        return (c1.lat === c2.lat && c1.lng === c2.lng);
    }

	// Args: layerName = "knooppunten" | "netwerken"
	//		 map = baseMap handle
	//		 layerControl = control handle
	function getKnooppunten (layerName, map, layerControl) {
		var mapURL = `
			http://geodata.nationaalgeoregister.nl/fietsknooppuntennetwerk/wms
			?FORMAT=kml
			&TRANSPARENT=TRUE
			&SERVICE=WMS
			&VERSION=1.1.1
			&REQUEST=GetMap
			&STYLES=
			&WIDTH=1047&HEIGHT=1192`;
			// ?LAYERS=knooppunten
			// &SRS=EPSG%3A28992
			// &BBOX=77395.905557391,389014.9,79154.865557391,391018.3
		var crs = "&EPSG%3A4236";
		var bounds = map.getBounds();
		var bbox = "&BBOX=" + bounds._southWest.lng + "," + bounds._southWest.lat + "," + bounds._northEast.lng + "," + bounds._northEast.lat;
		var layers = "&LAYERS=" + layerName;
		mapURL += layers + crs + bbox; 


		console.log(mapURL);
		console.log(bounds._southWest.lng);

		var xhttp = new XMLHttpRequest();
		xhttp.onreadystatechange = function() {
			if (this.readyState == 4 && this.status == 200) {
				var xmlDoc = this.responseXML;
                console.log("LOADING all", Boolean(netwerkenLoaded), Boolean(knooppuntenLoaded));
				if ( layerName == "knooppunten") {
					extractKnooppunten(xmlDoc);
                    layerControl.addOverlay(knooppuntenLayerGroup(knooppunten), "My Knooppunt layer");
                    knooppuntenLoaded = true;
				} else { // layerName == "netwerken"
					extractNetwerken(xmlDoc);
                    layerControl.addOverlay(netwerkenLayerGroup(netwerken), "My Netwerk layer");
                    netwerkenLoaded = true;
				}
                if (false && knooppuntenLoaded && netwerkenLoaded) {
                    console.log("loaded all", Boolean(netwerkenLoaded), Boolean(knooppuntenLoaded));
                    layerControl.addOverlay(matchEndPoints(), "Matching endpoints");
                }
			}
		};
		xhttp.open("GET", mapURL, true);
		xhttp.send();

	}

    function extractKnooppunten (xmlDoc) {
        // A knooppunt section is marked by the "Placemark" tag
        var x = xmlDoc.getElementsByTagName("Placemark");
        for (var i = 0; i < x.length; i++) {
            // Tag "name" marks the knooppuntnr
            var knptNr = x[i].getElementsByTagName("name")[0].innerHTML;
            // Tag "coordinates" marks the coordinates
            var knptArr = x[i].getElementsByTagName("coordinates")[0].innerHTML.split(',');
            var pointCoord = L.latLng(knptArr[1], knptArr[0]);
            knooppunten.push(new KnooppuntType(knptNr, pointCoord));
            // console.log(knptCoords[1] + ", " + knptCoords[0]);
        }
        // var mydoc = document.getElementById("mapdata");
    }

    
    function extractNetwerken (xmlDoc) {
        // Every "Placemark" tag marks a route part
        var x = xmlDoc.getElementsByTagName("Placemark");
        // Store every route part in the "netwerken" array
        for (var i = 0; i < x.length; i++) {
            var netwerkLineString = []; // LineString of netwerken coords
            // Tag "name" marks the netwerk name
            var netwerkName = x[i].getElementsByTagName("name")[0].innerHTML;
            // Tag "Point > coordinates" marks the Point coordinates
            var pointArr = x[i].getElementsByTagName("Point")[0].getElementsByTagName("coordinates")[0].innerHTML.split(',');
            var pointCoord = L.latLng(pointArr[1], pointArr[0]);
            // Tag "LineString > coordinates" marks the route coordinates
            var lineCoordArr = x[i].getElementsByTagName("LineString")[0].getElementsByTagName("coordinates")[0].innerHTML.split(' ');
            // console.log("NETWERKEN", lineCoordArr);
            for (var j = 0; j < lineCoordArr.length; j++) {
                var s = lineCoordArr[j].split(',');
                netwerkLineString.push(L.latLng(s[1], s[0]));
            }
            netwerken.push(new NetwerkenType(netwerkName, pointCoord, netwerkLineString));
            // console.log(knptCoords[1] + ", " + knptCoords[0]);
        }
        // var mydoc = document.getElementById("mapdata");
    }

	// Create layergroup of knooppunten
	// Arg: knooppunten = array of type Knooppunt
	function knooppuntenLayerGroup (knooppunten) {
		// create array with knooppunt markers
		var knptMarkers = [];
		for (i of knooppunten) {
            knptMarkers.push(
				L.marker(i.point).bindPopup(i.nr + "<br>(" + i.point.lat + ", " + i.point.lng + ")")
				.bindTooltip(i.nr, {
					permanent: true, 
                    riseOnHover: true,
					direction: 'right',
					offset: [-5, 0],
					className: 'markerTooltip'
				})
                .on('click', updateMyFietsrouteLayer("knooppunt", i))
                );
                

			// Beautify marker
			// options = {
            // 	isAlphaNumericIcon: true
            //     , text: i.nr
            //     , iconShape: 'marker'
            //     , borderColor: '#00ABDC'
            //     , textColor: '#00ABDC'
            //     , innerIconStyle: 'margin-top:0;'
       		// };
			// knptMarkers.push(L.BeautifyMarker.marker(i.point, { icon: L.BeautifyIcon.icon(options), draggable: false })
			// 	.bindPopup(i.nr + "<br>(" + i.point.lat + ", " + i.point.lng + ")")
			// );
       

		}
		return L.layerGroup(knptMarkers);
	}

    var iconOrange = L.icon({
        iconUrl: 'Image/map_marker-orange-small.png',
        iconSize: [32, 37],
        iconAnchor: [14, 36],
        popupAnchor: [-3, -76],
        // shadowUrl: 'my-icon-shadow.png',
        shadowSize: [68, 95],
        shadowAnchor: [22, 94]
    }); 

    // Args: type = "knooppunt" | "netwerken"
    var updateMyFietsrouteLayer = function (type, iC) {
        var visible = false;
        var layer;
        // Toggle selection and thus visibility
        return function (e) {
            console.log(visible, layer, e._leaflet_id);
            if (!visible) {
                if (type == "netwerken") {
                    myFietsrouteLayer.addLayer(layer = L.polyline(iC.coordinateArr, {color: 'yellow'}));
                    console.log("ADDed alayer: " + myFietsrouteLayer.getLayerId(layer));
                } else { // type == "knooppunt"
                    myFietsrouteLayer.addLayer(layer = L.marker(iC.point, {icon: iconOrange}));
                    console.log("Layer==5> ", layer);
                    // var layerId = myFietsrouteLayer.getLayerId(layer);
                    layer.on("click", myFietsrouteLayer.removeLayer(layer));
                }
            } else {
                console.log("REMOVE");
                // if (type == "netwerken") {
                    myFietsrouteLayer.removeLayer(layer);
                // } else { // type == "knooppunt"
                // }
            };
            visible = !visible;
        }
    }

	// Arg: netwerken = array of type NetwerkenType
	function netwerkenLayerGroup (netwerken) {
        var networkLayerGroup = L.layerGroup();
		// create array with knooppunt markers
		var netwerkMarkers = [];
		for (i of netwerken) {
			// console.log(i);
			// netwerkMarkers.push(L.marker([i.coordinateArr[0].lat, i.coordinateArr[0].lng]).bindPopup(i.name + "<br>(" + i.coordinateArr[0].lat + ", " + i.coordinateArr[0].lng + i.coordinateArr + ")"));
		// netwerkMarkers.push(L.marker(i.coordinateArr[0], {icon: L.divIcon({html: "<i>" + i.name + "</i>"})})
		// 	.bindPopup(i.name + "<br>(" + i.coordinateArr[0].lat + ", " + i.coordinateArr[0].lng + i.coordinateArr + ")")
		// 	);

		// Beautify marker start
		// options = {
        //     	isAlphaNumericIcon: true
        //         // , text: i.name
		// 		, text: i.name.split('.')[1]
        //         // , iconShape: 'doughnut'
        //         , borderColor: '#00ABDC'
        //         , textColor: '#00ABDC'
        //         , innerIconStyle: 'margin-top:0;'
       	// 	};
		// 	networkLayerGroup.addLayer(L.BeautifyMarker
		// 		.marker(i.point, { icon: L.BeautifyIcon.icon(options), draggable: false })
		// 		.bindPopup(i.name + "<br>(End1: " + i.coordinateArr[0].lat + ", " + i.coordinateArr[0].lng + ")<br>End2: "
		// 			+ i.coordinateArr[i.coordinateArr.length-1].lat + ", " + i.coordinateArr[i.coordinateArr.length-1].lng + ")"
		// 	)
		// Beautify marker end

			// normal marker start
			// networkLayerGroup.addLayer(L.marker(i.point, {icon: L.divIcon({html: "<i>" + i.name.split('.')[1] + "</i>", className: 'netwerkDivIcon'})})
            //     .bindPopup(i.name + "<br>(End1: " + i.coordinateArr[0].lat + ", " + i.coordinateArr[0].lng + ")<br>End2: "
			// 				+ i.coordinateArr[i.coordinateArr.length-1].lat + ", " + i.coordinateArr[i.coordinateArr.length-1].lng + ")"
			// 	) //i.coordinateArr + ")")

            networkLayerGroup.addLayer(L.marker(i.point, {icon: L.divIcon({
                        html: "<i>" + i.name.split('.')[1] + "</i>",
                        className: 'netwerkDivIcon',
                        riseOnHover: true,
                        title: "I'm the title"
                    })})
                .bindTooltip(
                    i.name + "<br>(End1: " + i.coordinateArr[0].lat + ", " + i.coordinateArr[0].lng + ")<br>End2: "
                                + i.coordinateArr[i.coordinateArr.length-1].lat + ", " + i.coordinateArr[i.coordinateArr.length-1].lng + ")"
                )
			// normal marker end
            // function in outer scope
                .on('click', updateMyFietsrouteLayer("netwerken", i))
            // function in inner scope
                // .on('click', function () {
                //     var iC = i;
                //     // var netwerkC = networkLayerGroup; 
                //     var visible = false;
                //     var layer;
                //     return function () {
                //         // Toggle line selection
                //         if (!visible) {
                //             myFietsrouteLayer.addLayer(layer = L.polyline(iC.coordinateArr, {color: 'yellow'}));
                //         } else {
                //             myFietsrouteLayer.removeLayer(myFietsrouteLayer.getLayerId(layer));
                //         };
                //         visible = !visible;
                // }}() )
            );
            // networkLayerGroup.addLayer(L.polyline(i.coordinateArr, {color: 'red'})); 
        // netwerkMarkers.push(L.polyline(i.coordinateArr, {color: 'red'}).on('click', function(e){console.log(e);}));
		}
		return networkLayerGroup;
	}

    
    function matchEndPoints () {
        var netwerkMarkers = [];
        var epAll = [];
        var ep = [];
        epAll[0] = []; epAll[1] = []; epAll[2] = []; // all endpoints
        for (var n = 0; n < netwerken.length; n++) {
            var ep = [];
            for (var i = 0; i < knooppunten.length; i++) {
                // look for match at first coord of line
                if ( compareCoord(knooppunten[i].point, netwerken[n].coordinateArr[0]) )  {
                    // Input sanity check, we shouldn't already have a first endpoint
                    if (netwerken[n].first) console.log("WARNING: double 'first' linepoint found for network: ", netwerken[n].name);
                    // console.log("match for ", i.nr);
                    ep.push(i);
                    netwerken[n].first = i;
                } 
                // look for match at last coord of line
                if ( compareCoord(knooppunten[i].point, netwerken[n].coordinateArr[netwerken[n].coordinateArr.length-1]) )  {
                    // Input sanity check, we shouldn't already have a last endpoint 
                    if (netwerken[n].last) console.log("WARNING: double 'last' linepoint found for network: ", netwerken[n].name);
                    ep.push(i);
                    netwerken[n].last = i;
                }
            }
            // console.log("==1> ", "epAll[" + ep.length + "]", "epAll.length: " + epAll.length);
            epAll[ep.length].push(n);
            // console.log("==2> n: ", n);
            // console.log("==3> 0: " + epAll[0].length + " |1:" + epAll[1].length + " |2:" + epAll[2].length + " - " + ep.length);
            if (ep.length == 0) {
                netwerkMarkers.push(L.polyline(netwerken[n].coordinateArr, {color: 'red'})
                    .on('click', function () {
                        var myn = netwerken[n];
                        var myk = knooppunten;
                        return function(e){console.log(e, myn.name, myk[myn.first], myk[myn.last]);
                    } }()));
                // console.log("#0 Endpoints found: ", n);
            } else if (ep.length == 1) {
                // console.log("#1 Endpoints found: ", n);
                netwerkMarkers.push(L.polyline(netwerken[n].coordinateArr, {color: 'black'})
                    .on('click', function () {
                        var myn = netwerken[n];
                        var myk = knooppunten;
                        return function(e){console.log(e, myn.name, myk[myn.first], myk[myn.last]);
                    } }()));
                    // .on('click', function(e){console.log(netwerken[n].name, netwerken[n].first, netwerken[n].last);}));
            } else if (ep.length == 2) {
                // console.log("#2 Endpoints found: ", n);
                // console.log("==4> MATCH found: ", netwerken[n]);
                netwerkMarkers.push(L.polyline(netwerken[n].coordinateArr, {color: 'blue'})
                    .on('click', function () {
                        var myn = netwerken[n];
                        var myk = knooppunten;
                        return function(e){console.log(e, myn.name, myk[myn.first], myk[myn.last]);
                    } }()));
                    // .on('click', function(e){console.log(netwerken[n].name, netwerken[n].first, netwerken[n].last);}));
            } else {
                console.log("WARNING: More than 2 Endpoints found, this is unexpected, not processing this data.", n);
                // netwerkMarkers.push(L.polyline(n.coordinateArr, {color: 'yellow'}).on('click', function(e){console.log(n.name);}));
            }
        }
        // console.log("Processed all endpoints", "2 endpoints: " + epAll[2].length, "1 endpoint: " + epAll[1].length, "0 endpoint: " + epAll[0].length);
        console.log("==3> 0: " + epAll[0].length + " |1:" + epAll[1].length + " |2:" + epAll[2].length + " - " + ep.length);
        // console.log("==3> 0: " + epAll[0] + " |1:" + epAll[1] + " |2:" + epAll[2] + " - " + ep.length);

        // Construct neterkK2K
        // Try to construct complete netwerk parts fromt knooppunt to knooppunt

        // Add all netwerken with 2 endpoints
        netwerkK2K = epAll[2].slice();
        
        // Try to connect netwerken with 1 endpoint
        for (var i = 0; i < epAll[1].length; i++) {

        }

        console.log(netwerkK2K, epAll[2]);
        // check if open endpoints can be matched
        // for (n of epAll[0]) {
        //     for (i of epAll[1]) {
        //          // look for match
        //         if ( (i.coordinateArr[0].lat == n.coordinateArr[0].lat) && (i.coordinateArr[0].lng == n.coordinateArr[0].lng) )  {
        //             // console.log("match for ", i.nr);
        //             ep.push(i);
        //         } 
        //     }
        // }
        return L.layerGroup(netwerkMarkers);
    }


	var baselayer = L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpandmbXliNDBjZWd2M2x6bDk3c2ZtOTkifQ._QA7i5Mpkd_m30IGElHziw', {
		maxZoom: 18,
		attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
			'<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
			'Imagery © <a href="http://mapbox.com">Mapbox</a>',
		id: 'mapbox.streets'
	});

	mymap = L.map('mapid', {
		center: [51.497469, 4.271493],
		zoom: 12,
		layers: [baselayer]
	});
	
	// L.marker([51.5, 4.19]).addTo(mymap)
	// 	.bindPopup("<b>Hello world!</b><br />I am a popup."); //.openPopup();

    var emptyLayer = L.tileLayer('');
	// knooppuntLayer = L.marker();
	knooppuntLayer = L.layerGroup([L.marker([51.49728786029085, 4.283883498524014]).bindPopup("hoi")]); //.addLayer(knooppuntLayer);
	// knooppuntLayer = L.marker([51.49728786029085, 4.283883498524014]);
	// knooppuntLayer = L.layerGroup([markerX]);
	
	// officiele knooppunten
	var wmsKnooppuntLayer = L.tileLayer.wms('https://geodata.nationaalgeoregister.nl/fietsknooppuntennetwerk/ows?', {
		layers: 'knooppunten',
		format: 'image/png',
		transparent: true,
	}).addTo(mymap);

	// officieel netwerk
	var wmsNetwerkLayer = L.tileLayer.wms('https://geodata.nationaalgeoregister.nl/fietsknooppuntennetwerk/ows?', {
		layers: 'netwerken',
		format: 'image/png',
		transparent: true,
	}).addTo(mymap);
	
	var baseMaps = {
		"Basismap": baselayer,
		"No maps": emptyLayer
	}

	var overlayMaps = {
		"Officiele Netwerken" : wmsNetwerkLayer,
		"Officiele Knooppunten" : wmsKnooppuntLayer,
        "Mijn Fietsroute" : myFietsrouteLayer
		// "Knooppunten": knooppuntLayer
	}

	var mycontrol = L.control.layers(baseMaps, overlayMaps).addTo(mymap);
	// L.layerGroup([L.marker([51.49728786029085, 4.284883498524014]).bindPopup("nieuw")]).addLayer(knooppuntLayer).addTo(mymap);
	getKnooppunten("knooppunten", mymap, mycontrol);
	getKnooppunten("netwerken", mymap, mycontrol);
	// console.log(xtd);
	// mycontrol.addOverlay(xtd, "2e knooppunten");
	// mycontrol.addLayer(getKnooppunten(), "knoop");

    // // Convenience method: show coordinates of map location when map is clicked
	// function onMapClick(e) {
	// 	L.popup()
	// 		.setLatLng(e.latlng)
	// 		.setContent("Coordinaten:<br>" + e.latlng.toString())
	// 		.openOn(mymap);
	// }
	// mymap.on('click', onMapClick);

    // Implement "Toon route" button
    htmlMijnRoute = document.getElementById("mijn-route");
    htmlMijnRoute.innerHTML = "Initializing...";

    function toonMijnRoute () {
        console.log(myFietsrouteLayer.getLayers());
        htmlMijnRoute.innerHTML = myFietsrouteLayer.getLayers();
    }

    toonMijnRoute();

</script>



</body>
</html>
